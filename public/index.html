<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <link rel="stylesheet" href="jquery.range.css">
  <style>
  .slider-container {
    -webkit-user-select:none;
    -khtml-user-select:none;
    -moz-user-select:none;
    -ms-user-select:none;
    -o-user-select:none;
    user-select:none;
    height: 50px;
  }
  .leftpanel {
    margin: none;
    float: left;
  }

  .rightpanel {
    margin-left: 20px;
    width: 250px;
    font: 12px sans-serif;
    float: left;
  }
  </style>
</head>
<body>
  <div class="leftpanel">
    <svg></svg>
  </div>
  <div class="rightpanel">
    <p>Temp:</p><br/>
    <input type = "hidden" class="range-temp" value="2.2,33"/>
    <p>Humidity:</p><br/>
    <input type = "hidden" class="range-humidity" value="15,100"/>
    <p>Wind:</p><br/>
    <input type = "hidden" class="range-wind" value="0.4,9.4"/>
  </div>
  <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
  <script src="/jquery.range-min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script>
    var width = 800;
    var height = 800;
    var margin = { left: 20, right:20, top:20, bottom: 20};
    var svg = d3.select("svg").attr("width", width).attr("height", height)
    var minTemp = 2.2;
    var maxTemp = 33;
    var minHumidity = 15;
    var maxHumidity = 100;
    var minWind = 0.4;
    var maxWind = 9.4;

    updateData();

    $('.range-temp').jRange({
      from: 2.2,
      to: 33,
      step: 0.1,
      width: 300,
      isRange : true,
      onstatechange: tempChanged
    });

    $('.range-humidity').jRange({
      from: 15,
      to: 100,
      step: 0.1,
      width: 300,
      isRange : true,
      onstatechange: humidityChanged
    });

    $('.range-wind').jRange({
      from: 0.4,
      to: 9.4,
      step: 0.1,
      width: 300,
      isRange : true,
      onstatechange: windChanged
    });

    function tempChanged(obj, value) {
      var values = value.split(",");
      minTemp = values[0];
      maxTemp = values[1];
      updateData();
    }

    function humidityChanged(obj, value) {
      var values = value.split(",");
      minHumidity = values[0];
      maxHumidity = values[1];
      updateData();
    }

    function windChanged(obj, value) {
      var values = value.split(",");
      minWind = values[0];
      maxWind = values[1];
      updateData();
    }

    /** Queries database and displays points **/
    function updateData() {
      d3.json("/points?minTemp="+minTemp+"&maxTemp="+maxTemp+"&minWind="+minWind+"&maxWind="+maxWind+"&minHumidity="+minHumidity+"&maxHumidity="+maxHumidity)
      .header("Content-Type", "application/json")
      .get(function(error, data) {
        // callback
        if(error) {
          console.log(error);
          return;
        }
        console.log(data[0]);

        //combine overlapping data
        for(var i = 0; i < data.length-1; ++i) {
          data[i].weight = 1;
          for(var j = i+1; j < data.length; ++j) {
            //combine data points;
            if(data[i].X == data[j].X && data[i].Y == data[j].Y){
              data[i].weight++;
              data.splice(j, 1);
              --j;
            }
          }
        }

        //handle scales
        var xScale = d3.scale.linear()
                      .domain(
                        [d3.min(data, function(d) { return d.X; }),
                         d3.max(data, function(d) { return d.X; })]
                      )
                      .range([margin.left, width-margin.right]);
        //handle scales
        var yScale = d3.scale.linear()
                      .domain(
                        [d3.min(data, function(d) { return d.Y; }),
                         d3.max(data, function(d) { return d.Y; })]
                      )
                      .range([margin.top, height-margin.bottom]);

        //append circles
        var circ = svg.selectAll("circle")
          .data(data, function(d) { return d.X +"/"+ d.Y; })
        circ.enter()
          .append("circle")
          .attr("cx", function(d) { return xScale(d.X); })
          .attr("cy", function(d) { return yScale(d.Y); })
          .attr("fill", "lightcoral")
          .attr("r", 0);
        circ.transition()
          .attr("r", function(d) {return 5 + Math.pow(d.weight, 0.5)});
        circ.exit().transition().attr("r", 0).remove();
      });
    }
  </script>
</body>
</script>
